#!/bin/bash
set -e

AWS_REGION="eu-west-1"

# Dynamically generated by TF
export MODEL_BUCKET_PROD="s3-tf-credit-default-risk-prediction"
export PREDICTIONS_STREAM_NAME="out-stream-tf-credit-default-risk-prediction"
export LAMBDA_FUNCTION="lambda-tf-credit-default-risk-prediction"

# Model artifacts bucket from MLflow experiments
export MODEL_BUCKET_DEV="mlflow-credit-default-risk-prediction-artifact-store-v2"

# Get latest RUN_ID from latest S3 partition (top-level folder)
export RUN_ID=$(aws s3api list-objects-v2 \
  --bucket ${MODEL_BUCKET_DEV} \
  --query 'sort_by(Contents, &LastModified)[-1].Key' \
  --output text | cut -d/ -f1)

echo "Latest RUN_ID: $RUN_ID"

# Sync all artifacts from DEV to PROD bucket
aws s3 sync s3://${MODEL_BUCKET_DEV}/${RUN_ID}/artifacts s3://${MODEL_BUCKET_PROD}/${RUN_ID}/artifacts

# Set new vars for Lambda environment
variables="{PREDICTIONS_STREAM_NAME=${PREDICTIONS_STREAM_NAME},MODEL_BUCKET=${MODEL_BUCKET_PROD},RUN_ID=${RUN_ID}}"

# Update Lambda environment with the latest RUN_ID
aws lambda update-function-configuration \
  --function-name ${LAMBDA_FUNCTION} \
  --environment "Variables=${variables}"
